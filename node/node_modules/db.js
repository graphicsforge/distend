
var System = require('cassandra-client').System;
var sys = new System('localhost:9160');
var uuid = new require('uuid-js');

var PooledConnection = require('cassandra-client').PooledConnection;
var hosts = ['localhost:9160'];
var connection_pool = new PooledConnection({'hosts': hosts, 'keyspace': 'distend'});

function initUsers( callback )
{
  // initialize user table if we don't have one yet
  connection_pool.execute('CREATE TABLE users ('+
    'username text PRIMARY KEY,'+
    'img text,'+
    'firstName text,'+
    'lastName text)'
    , [], function(err) {
      callback();
    }
  );
}

function initChat( callback )
{
  // initialize user table if we don't have one yet
  connection_pool.execute('CREATE TABLE chat ('+
    'timeuuid uuid PRIMARY KEY,'+
    'username text,'+
    'msg text)'
    , [], function(err) {
console.log('made chat');
      callback();
    }
  );
}


function FBSignIn( username, img, firstName, lastName, callback )
{
  initUsers( function(){
    var connection_pool = new PooledConnection({'hosts': hosts, 'keyspace': 'distend'});
    connection_pool.execute('UPDATE users SET img=?, firstName=?, lastName=? WHERE username=?',
      [img, firstName, lastName, username],
      function(err) {
        if ( err ) { console.log(err); return; }
        callback();
      }
    );
  });
}

function postChat( username, message, callback )
{
  initChat( function(){
    var connection_pool = new PooledConnection({'hosts': hosts, 'keyspace': 'distend'});
    var keynow = uuid.create(1);
    connection_pool.execute('UPDATE chat SET username=?, msg=? WHERE timeuuid=?',
      [username, message, keynow],
      function(err) {
        if ( err ) { console.log(err); return; }
        callback();
      }
    );

  });
}

function grabChat( callback )
{
    var connection_pool = new PooledConnection({'hosts': hosts, 'keyspace': 'distend'});
    var keynow = uuid.create(1);
    connection_pool.execute("SELECT 'username', 'msg' FROM chat",
      [],
      function(err, rows) {
        if ( err ) { console.log(err); return; }
//var util = require('util');
//console.log( "posts "+util.inspect(rows) );
        callback(rows.map(function(row){
          return row.colHash;
        }));
      }
    );

}

module.exports = {
  FBSignIn: FBSignIn,
  postChat: postChat,
  grabChat: grabChat
}
